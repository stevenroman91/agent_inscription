<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent d'inscription Sciences Po Aix</title>
    <link rel="icon" type="image/svg+xml" href="https://www.sciencespo-aix.fr/wp-content/uploads/2022/10/SciencesPoAix_Logotype-Complet_Couleur-1.svg">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #9ca3af;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 24px;
            box-shadow: 0 25px 70px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 0, 0, 0.05);
            width: 100%;
            max-width: 900px;
            height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .header {
            background: #9ca3af;
            color: white;
            padding: 28px 25px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(156, 163, 175, 0.3);
            position: relative;
        }
        
        .header-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .header-logo img {
            height: 40px;
            width: auto;
        }
        
        .header-logo-text {
            font-size: 24px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .header h1 {
            font-size: 26px;
            margin-bottom: 8px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .header p {
            opacity: 0.95;
            font-size: 14px;
            font-weight: 400;
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 24px 20px;
            background: #ffffff;
        }

        .chat-container::-webkit-scrollbar {
            width: 6px;
        }

        .chat-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-container::-webkit-scrollbar-thumb {
            background: #EE2737;
            border-radius: 3px;
        }

        .chat-container::-webkit-scrollbar-thumb:hover {
            background: #d91e2e;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            justify-content: flex-end;
        }

        .message.assistant {
            justify-content: flex-start;
        }

        .message-bubble {
            max-width: 75%;
            padding: 16px 20px;
            border-radius: 20px;
            word-wrap: break-word;
            line-height: 1.6;
            font-size: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .message.user .message-bubble {
            background: #9ca3af;
            color: white;
            border-bottom-right-radius: 6px;
            box-shadow: 0 4px 12px rgba(238, 39, 55, 0.3);
        }

        .message.assistant .message-bubble {
            background: #ffffff;
            color: #2c3e50;
            border: none;
            border-bottom-left-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .message.assistant .message-bubble strong {
            color: #EE2737;
            font-weight: 600;
        }

        .input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            gap: 12px;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.03);
        }

        .input-container input {
            flex: 1;
            padding: 16px 24px;
            border: 2px solid #e8eaf0;
            border-radius: 16px;
            font-size: 15px;
            outline: none;
            transition: all 0.2s ease;
            background: #f8f9fa;
            color: #2c3e50;
        }

        .input-container input:focus {
            border-color: #EE2737;
            background: white;
            box-shadow: 0 0 0 4px rgba(238, 39, 55, 0.1);
        }

        .input-container input::placeholder {
            color: #a0aec0;
        }

        .input-container button {
            padding: 16px 32px;
            background: #EE2737;
            color: white;
            border: none;
            border-radius: 16px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(238, 39, 55, 0.3);
        }

        .input-container button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(238, 39, 55, 0.4);
        }

        .input-container button:active {
            transform: translateY(0);
        }

        .input-container button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .quick-actions {
            padding: 16px 20px;
            background: #ffffff;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            backdrop-filter: blur(10px);
        }

        .quick-action-btn {
            padding: 10px 18px;
            background: white;
            border: 1.5px solid #e8eaf0;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #4a5568;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .quick-action-btn:hover {
            background: #EE2737;
            color: white;
            border-color: transparent;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(238, 39, 55, 0.3);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .status {
            text-align: center;
            padding: 12px;
            font-size: 13px;
            color: #718096;
            font-weight: 500;
        }

        .status.error {
            color: #e53e3e;
            background: rgba(229, 62, 62, 0.1);
            border-radius: 8px;
            margin: 0 20px 8px;
        }

        .status.success {
            color: #27ae60;
            background: rgba(39, 174, 96, 0.1);
            border-radius: 8px;
            margin: 0 20px 8px;
        }

        .message-bubble.error {
            background: #fff5f5;
            border: 1px solid #feb2b2;
            color: #c53030;
        }

        .form-container {
            display: none;
            padding: 20px;
        }

        .form-container.active {
            display: block;
        }

        .form-step {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .form-step h3 {
            margin-bottom: 15px;
            color: #EE2737;
        }

        .form-step input,
        .form-step select,
        .form-step textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 15px;
        }

        .form-step input:focus,
        .form-step select:focus,
        .form-step textarea:focus {
            border-color: #EE2737;
            outline: none;
        }

        .form-navigation {
            display: flex;
            gap: 10px;
            justify-content: space-between;
            margin-top: 20px;
        }

        .form-navigation button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #9ca3af;
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(238, 39, 55, 0.4);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .progress-indicator {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .progress-step {
            flex: 1;
            padding: 10px;
            text-align: center;
            border-radius: 5px;
            background: #e0e0e0;
            color: #666;
            font-size: 14px;
        }

        .progress-step.active {
            background: #667eea;
            color: white;
        }

        .progress-step.completed {
            background: #27ae60;
            color: white;
        }

        .phase-indicator {
            padding: 14px 20px;
            background: #ffffff;
            border-bottom: 2px solid rgba(238, 39, 55, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
        }

        .phase-indicator .phase-badge {
            padding: 8px 18px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
        }

        .phase-badge.phase1 {
            background: #9ca3af;
            color: white;
        }

        .phase-badge.phase2 {
            background: #2ecc71;
            color: white;
        }

        .documents-list {
            background: #f8f9fa;
            padding: 24px;
            border-radius: 16px;
            margin: 16px 0;
            border: 2px solid #e8eaf0;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        }

        .documents-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid #e8eaf0;
        }

        .documents-list-title {
            font-size: 18px;
            font-weight: 700;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .documents-list-title::before {
            content: "üìã";
            font-size: 24px;
        }

        .export-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .export-btn {
            padding: 8px 16px;
            border: 1.5px solid #e8eaf0;
            border-radius: 10px;
            background: white;
            color: #4a5568;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .export-btn:hover {
            background: #9ca3af;
            color: white;
            border-color: transparent;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(238, 39, 55, 0.3);
        }

        .documents-list ul {
            margin: 0;
            padding: 0;
            list-style: none;
        }

        .documents-list li {
            margin: 12px 0;
            padding: 14px 16px;
            padding-left: 48px;
            position: relative;
            color: #2c3e50;
            line-height: 1.6;
            background: white;
            border-radius: 10px;
            border: 1px solid #e8eaf0;
            transition: all 0.2s;
        }

        .documents-list li:hover {
            border-color: #EE2737;
            box-shadow: 0 2px 8px rgba(238, 39, 55, 0.15);
            transform: translateX(4px);
        }

        .documents-list li::before {
            content: "‚òê";
            position: absolute;
            left: 16px;
            top: 14px;
            font-size: 18px;
            color: #EE2737;
            font-weight: bold;
        }

        .documents-list li.completed::before {
            content: "‚úì";
            color: #27ae60;
        }

        .quick-reply-buttons {
            display: flex;
            gap: 10px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .quick-reply-btn {
            padding: 10px 20px;
            background: #EE2737;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(238, 39, 55, 0.3);
        }

        .quick-reply-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(238, 39, 55, 0.4);
        }

        .quick-reply-btn:active {
            transform: translateY(0);
        }

        .quick-reply-btn.secondary {
            background: #7f8c8d;
        }

        /* Styles pour les choix multiples (radio buttons) */
        .choice-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 16px;
        }

        .choice-option {
            display: flex;
            align-items: center;
            padding: 14px 18px;
            background: white;
            border: 2px solid #e8eaf0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .choice-option:hover {
            border-color: #EE2737;
            background: #fff5f5;
            transform: translateX(4px);
        }

        .choice-option input[type="radio"] {
            margin-right: 12px;
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #EE2737;
        }

        .choice-option.selected {
            border-color: #EE2737;
            background: #fff5f5;
            box-shadow: 0 2px 8px rgba(238, 39, 55, 0.2);
        }

        .choice-option label {
            flex: 1;
            cursor: pointer;
            font-size: 15px;
            color: #2c3e50;
            font-weight: 500;
        }

        .choice-submit-btn {
            margin-top: 16px;
            padding: 12px 24px;
            background: #EE2737;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(238, 39, 55, 0.3);
        }

        .choice-submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(238, 39, 55, 0.4);
        }

        .choice-submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .account-form-container {
            margin-top: 10px;
        }

        .account-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #e8eaf0;
        }

        .account-form h3 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 18px;
        }

        .account-form input {
            transition: border-color 0.2s;
        }

        .account-form input:focus {
            outline: none;
            border-color: #EE2737;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-logo">
                <img src="https://www.sciencespo-aix.fr/wp-content/uploads/2022/10/SciencesPoAix_Logotype-Complet_Couleur-1.svg" alt="Sciences Po Aix" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                <div class="header-logo-text" style="display: none;">Sciences Po Aix</div>
            </div>
            <h1>Agent d'inscription administrative</h1>
            <p>Votre assistant intelligent pour l'inscription</p>
        </div>

        <div class="phase-indicator" id="phaseIndicator" style="display: none;">
            <span>
                <span class="phase-badge phase1" id="phase1Badge">Phase 1: Collecte d'informations</span>
                <span class="phase-badge phase2" id="phase2Badge" style="display: none;">Phase 2: Remplissage du formulaire</span>
            </span>
            <span id="sessionInfo" style="font-size: 11px; color: #666;"></span>
        </div>

        <div class="chat-container" id="chatContainer">
            <div class="message assistant">
                <div class="message-bubble">
                    üëã Bonjour ! Je suis votre assistant pour l'inscription √† Sciences Po Aix.
                    <p style="margin-top: 15px; font-weight: 600;">Que souhaitez-vous faire aujourd'hui ?</p>
                    <div style="margin-top: 20px; display: flex; flex-direction: column; gap: 12px;">
                        <button onclick="startDocumentCheck()" style="padding: 18px 20px; background: #EE2737; color: white; border: none; border-radius: 14px; cursor: pointer; font-size: 15px; text-align: left; box-shadow: 0 4px 12px rgba(238, 39, 55, 0.3); transition: all 0.2s; font-weight: 500;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(238, 39, 55, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(238, 39, 55, 0.3)'">
                            <div style="font-size: 20px; margin-bottom: 6px;">üìã</div>
                            <div style="font-weight: 600; margin-bottom: 4px;">D√©couvrir quels documents je dois fournir</div>
                            <div style="font-size: 13px; opacity: 0.95; font-weight: 400;">Je vais vous poser quelques questions pour d√©terminer exactement les pi√®ces n√©cessaires</div>
                        </button>
                        <button onclick="startForm()" style="padding: 18px 20px; background: #EE2737; color: white; border: none; border-radius: 14px; cursor: pointer; font-size: 15px; text-align: left; box-shadow: 0 4px 12px rgba(238, 39, 55, 0.3); transition: all 0.2s; font-weight: 500;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(238, 39, 55, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(238, 39, 55, 0.3)'">
                            <div style="font-size: 20px; margin-bottom: 6px;">üìù</div>
                            <div style="font-weight: 600; margin-bottom: 4px;">Commencer mon inscription compl√®te</div>
                            <div style="font-size: 13px; opacity: 0.95; font-weight: 400;">Processus guid√© en 2 phases : d√©termination des documents puis remplissage du formulaire</div>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="quick-actions" id="quickActions">
            <button class="quick-action-btn" onclick="sendQuickMessage('Quelles sont les pi√®ces √† fournir ?')" id="btnPieces">
                üìã Pi√®ces √† fournir
            </button>
            <button class="quick-action-btn" onclick="sendQuickMessage('Quels sont les codes disponibles ?')" id="btnCodes">
                üîë Codes d'inscription
            </button>
            <button class="quick-action-btn" onclick="sendQuickMessage('Aide-moi √† remplir le formulaire')" id="btnAide">
                ‚úçÔ∏è Aide formulaire
            </button>
            <button class="quick-action-btn" onclick="resetConversation()">
                üîÑ Nouvelle session
            </button>
            <button class="quick-action-btn" onclick="showSessionInfo()">
                üìã Info session
            </button>
            <button class="quick-action-btn" onclick="showLoginForm()">
                üîê Se connecter
            </button>
            <button class="quick-action-btn" onclick="validateDocuments()">
                ‚úÖ Valider mes documents
            </button>
            <button class="quick-action-btn" onclick="startDocumentCheck()">
                üìã Documents n√©cessaires
            </button>
            <button class="quick-action-btn" onclick="startForm()">
                üìù Inscription compl√®te
            </button>
        </div>

        <div class="input-container">
            <input 
                type="text" 
                id="userInput" 
                placeholder="Posez votre question..."
                onkeypress="handleKeyPress(event)"
            >
            <button id="sendButton" onclick="sendMessage()">Envoyer</button>
        </div>

        <div class="status" id="status"></div>
    </div>

    <script>
        const chatContainer = document.getElementById('chatContainer');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const status = document.getElementById('status');

        function addMessage(text, isUser, quickReplies = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'assistant'}`;
            
            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            bubble.innerHTML = text; // Utiliser innerHTML pour interpr√©ter le HTML
            
            // Ajouter les boutons de r√©ponse rapide si fournis
            if (quickReplies && !isUser) {
                const replyContainer = document.createElement('div');
                replyContainer.className = 'quick-reply-buttons';
                
                quickReplies.forEach(reply => {
                    const btn = document.createElement('button');
                    btn.className = 'quick-reply-btn' + (reply.secondary ? ' secondary' : '');
                    btn.textContent = reply.text;
                    btn.onclick = () => {
                        // Simuler l'envoi du message
                        userInput.value = reply.text;
                        sendMessage();
                    };
                    replyContainer.appendChild(btn);
                });
                
                bubble.appendChild(replyContainer);
            }
            
            messageDiv.appendChild(bubble);
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function showStatus(message, type = '') {
            status.textContent = message;
            status.className = `status ${type}`;
            if (message) {
                setTimeout(() => {
                    status.textContent = '';
                    status.className = 'status';
                }, 3000);
            }
        }

        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;

            // Afficher le message de l'utilisateur
            addMessage(message, true);
            userInput.value = '';
            sendButton.disabled = true;
            sendButton.innerHTML = '<span class="loading"></span>';

            // D√©tecter les actions sp√©ciales AVANT d'envoyer √† l'agent
            const lowerMessage = message.toLowerCase().trim();
            
            // D√©tection cr√©ation de compte (priorit√© absolue)
            if (lowerMessage.includes('cr√©er un compte') || 
                lowerMessage.includes('creer un compte') || 
                lowerMessage.includes('oui cr√©er') ||
                (lowerMessage === 'oui' && lastQuestionAsked === 'create_account') ||
                (lowerMessage.startsWith('oui') && lastQuestionAsked === 'create_account')) {
                console.log('‚úÖ D√©tection cr√©ation de compte - affichage du formulaire');
                showAccountCreationForm();
                sendButton.disabled = false;
                sendButton.textContent = 'Envoyer';
                userInput.focus();
                return;
            }
            
            // D√©tection skip compte
            if ((lowerMessage.includes('sans compte') || lowerMessage.includes('continuer sans') || 
                 (lowerMessage === 'non' && lastQuestionAsked === 'create_account'))) {
                skipAccountCreation();
                sendButton.disabled = false;
                sendButton.textContent = 'Envoyer';
                userInput.focus();
                return;
            }
            
            // D√©tection Phase 2
            if (lowerMessage.includes('commencer la phase 2') || 
                lowerMessage.includes('phase 2') || 
                (lowerMessage === 'oui' && lastQuestionAsked === 'phase2_confirm')) {
                await startPhase2();
                sendButton.disabled = false;
                sendButton.textContent = 'Envoyer';
                userInput.focus();
                return;
            }
            
            // D√©tection pour commencer Phase 1 depuis Phase 2
            if ((lowerMessage.includes('commencer par la phase 1') || 
                 lowerMessage.includes('phase 1') || 
                 (lowerMessage === 'oui' && lastQuestionAsked === 'phase2_no_account'))) {
                await startDocumentCheck();
                sendButton.disabled = false;
                sendButton.textContent = 'Envoyer';
                userInput.focus();
                return;
            }
            
            // D√©tection pour cr√©er un compte depuis Phase 2
            if ((lowerMessage.includes('cr√©er un compte') || 
                 lowerMessage.includes('creer un compte') || 
                 (lowerMessage === 'oui' && (lastQuestionAsked === 'phase2_no_account' || lastQuestionAsked === 'phase2_account_creation')))) {
                showAccountCreationForm();
                sendButton.disabled = false;
                sendButton.textContent = 'Envoyer';
                userInput.focus();
                return;
            }
            
            // D√©tection pour "Non, continuer sans compte" depuis Phase 2
            if ((lowerMessage.includes('non') || lowerMessage.includes('continuer sans compte')) && 
                lastQuestionAsked === 'phase2_account_creation') {
                // L'utilisateur ne veut pas cr√©er de compte : continuer directement avec Phase 2
                addMessage('D\'accord, vous continuerez sans compte. Votre progression sera sauvegard√©e localement.', false);
                // Continuer avec la Phase 2
                setTimeout(async () => {
                    try {
                        const response = await fetch(`/api/profile/${currentSessionId}/phase2`, {
                            method: 'POST'
                        });
                        const data = await response.json();
                        
                        currentPhase = 'remplissage_formulaire';
                        updatePhaseIndicator(currentPhase, currentSessionId);
                        
                        addMessage('üìã Parfait ! Passons √† la Phase 2 : le remplissage du formulaire d\'inscription.', false);
                        addMessage('Je vais vous poser des questions pour remplir chaque champ du formulaire.', false);
                        addMessage('', false);
                        addMessage('Commen√ßons par vos informations personnelles. Quel est votre nom de famille ?', false);
                    } catch (error) {
                        showStatus('Erreur lors du d√©marrage de la Phase 2', 'error');
                    }
                }, 500);
                sendButton.disabled = false;
                sendButton.textContent = 'Envoyer';
                userInput.focus();
                return;
            }
            
            // D√©tection pour "Oui, j'ai un compte" ou "Non, je n'ai pas de compte"
            if (lastQuestionAsked === 'has_account_check') {
                if (lowerMessage.includes('oui') || lowerMessage.includes('j\'ai un compte') || lowerMessage.includes('jai un compte')) {
                    // L'utilisateur a un compte : demander de se connecter
                    addMessage('üîê Parfait ! Veuillez vous connecter pour r√©cup√©rer votre progression.', false);
                    showLoginForm();
                    sendButton.disabled = false;
                    sendButton.textContent = 'Envoyer';
                    userInput.focus();
                    return;
                } else if (lowerMessage.includes('non') || lowerMessage.includes('pas de compte') || lowerMessage.includes('n\'ai pas')) {
                    // L'utilisateur n'a pas de compte : commencer par la Phase 1
                    clearSession();
                    currentSessionId = null;
                    currentPhase = 'collecte_info';
                    addMessage('üìã Parfait ! Nous allons commencer par la Phase 1 : d√©terminer quels documents vous devez fournir.', false);
                    addMessage('', false);
                    await startDocumentCheck(true);
                    sendButton.disabled = false;
                    sendButton.textContent = 'Envoyer';
                    userInput.focus();
                    return;
                }
            }
            
            // D√©tection pour se connecter depuis Phase 2
            if ((lowerMessage.includes('se connecter') || 
                 lowerMessage.includes('connecter') || 
                 (lowerMessage === 'oui' && lastQuestionAsked === 'phase2_need_login'))) {
                showLoginForm();
                sendButton.disabled = false;
                sendButton.textContent = 'Envoyer';
                userInput.focus();
                return;
            }
            
            // D√©tection pour "Commencer par la Phase 1" apr√®s demande de connexion
            if (lastQuestionAsked === 'phase2_need_login' && 
                (lowerMessage.includes('commencer') || lowerMessage.includes('phase 1') || lowerMessage.includes('phase1'))) {
                clearSession();
                currentSessionId = null;
                currentPhase = 'collecte_info';
                addMessage('üìã Parfait ! Nous allons commencer par la Phase 1 : d√©terminer quels documents vous devez fournir.', false);
                addMessage('', false);
                await startDocumentCheck(true);
                sendButton.disabled = false;
                sendButton.textContent = 'Envoyer';
                userInput.focus();
                return;
            }
            
            // Pendant la phase de collecte, on g√®re tout c√¥t√© client sans l'agent
            // NE PAS forcer collecte_info si on est d√©j√† en remplissage_formulaire
            if (currentPhase === 'collecte_info' && currentSessionId) {
                // D√©tecter et mettre √† jour le profil
                console.log('üîç D√©tection du message:', message);
                console.log('üìä √âtat avant d√©tection - currentPhase:', currentPhase, 'currentSessionId:', currentSessionId);
                const profileUpdated = await detectAndUpdateProfile(message);
                console.log('‚úÖ Profil mis √† jour:', profileUpdated);
                
                // Ne PAS envoyer √† l'agent pendant la phase de collecte
                sendButton.disabled = false;
                sendButton.textContent = 'Envoyer';
                userInput.focus();
                
                // R√©initialiser lastQuestionAsked si le profil a √©t√© mis √† jour
                // pour permettre la question suivante
                if (profileUpdated) {
                    lastQuestionAsked = null;
                    console.log('üîÑ lastQuestionAsked r√©initialis√© apr√®s mise √† jour');
                }
                
                // Toujours poser la question suivante apr√®s un d√©lai
                // (m√™me si pas de mise √† jour d√©tect√©e, pour continuer le flow)
                const delay = profileUpdated ? 1500 : 1000;
                console.log('‚è∞ Planification de la prochaine question dans', delay, 'ms');
                setTimeout(async () => {
                    console.log('üìù Appel de askNextQuestion() - currentPhase:', currentPhase);
                    // S'assurer que questionInProgress est false avant d'appeler
                    questionInProgress = false;
                    console.log('üîì questionInProgress r√©initialis√© avant askNextQuestion');
                    await askNextQuestion();
                }, delay);
                
                return;
            }
            
            // S'assurer qu'un profil existe avant d'utiliser l'agent
            // Ne pas restaurer automatiquement si l'utilisateur n'a pas de compte
            if (!currentSessionId) {
                const savedEmail = localStorage.getItem('spaix_account_email');
                // Si pas de compte, ne pas restaurer la session automatiquement
                await initializeProfile(false, !savedEmail);
            }
            
            // En Phase 2 (remplissage_formulaire), on utilise l'agent pour remplir le formulaire
            // En dehors de la phase de collecte, on utilise l'agent normalement
            // MAIS on v√©rifie d'abord si la question est li√©e aux inscriptions
            
            // V√©rifier si la question est hors sujet (lowerMessage d√©j√† d√©fini plus haut)
            const offTopicKeywords = ['m√©t√©o', 'temps', 'weather', 'cr√©er un email', 'cr√©er email', 'aide email', 
                                     'aide-moi √† cr√©er', 'aide moi', 'comment cr√©er', 'cr√©er mail', 'faire un mail',
                                     'g√©n√©ral', 'autre chose', 'autre question', 'autre sujet'];
            
            const isOffTopic = offTopicKeywords.some(keyword => lowerMessage.includes(keyword));
            
            if (isOffTopic && currentPhase !== 'remplissage_formulaire') {
                addMessage('Je suis d√©sol√©, je ne peux aider qu\'avec les inscriptions √† Sciences Po Aix. Comment puis-je vous aider avec votre inscription ?', false);
                sendButton.disabled = false;
                sendButton.textContent = 'Envoyer';
                userInput.focus();
                return;
            }

            // Cr√©er un √©l√©ment pour la r√©ponse en streaming
            const responseDiv = document.createElement('div');
            responseDiv.className = 'message assistant';
            const responseBubble = document.createElement('div');
            responseBubble.className = 'message-bubble';
            responseBubble.id = 'streamingResponse_' + Date.now();
            responseDiv.appendChild(responseBubble);
            chatContainer.appendChild(responseDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            try {
                // R√©cup√©rer l'email du compte connect√© si disponible
                const accountEmail = localStorage.getItem('spaix_account_email');
                
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        message: message,
                        session_id: currentSessionId || undefined,
                        account_email: accountEmail && accountEmail.trim() !== '' && accountEmail !== 'null' && accountEmail !== 'undefined' ? accountEmail : undefined
                    })
                });

                if (!response.ok) {
                    throw new Error('Erreur lors de la communication avec le serveur');
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop(); // Garder la ligne incompl√®te

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                if (data.content) {
                                    // Ajouter le contenu en pr√©servant le HTML existant
                                    const currentText = responseBubble.innerHTML || '';
                                    responseBubble.innerHTML = currentText + data.content;
                                    chatContainer.scrollTop = chatContainer.scrollHeight;
                                }
                                if (data.done) {
                                    if (data.error) {
                                        responseBubble.className = 'message-bubble error';
                                    } else {
                                        // V√©rifier si c'est une question oui/non et ajouter des boutons
                                        // Attendre un peu pour que tout le contenu soit affich√©
                                        setTimeout(() => {
                                            checkAndAddQuickReplies(responseBubble);
                                        }, 500);
                                    }
                                    sendButton.disabled = false;
                                    sendButton.textContent = 'Envoyer';
                                    userInput.focus();
                                    showStatus('Message envoy√©', 'success');
                                    return;
                                }
                            } catch (e) {
                                console.error('Erreur parsing SSE:', e);
                            }
                        }
                    }
                }

            } catch (error) {
                responseBubble.innerHTML = '‚ùå D√©sol√©, une erreur est survenue. Veuillez r√©essayer.';
                responseBubble.className = 'message-bubble error';
                showStatus('Erreur: ' + error.message, 'error');
            } finally {
                sendButton.disabled = false;
                sendButton.textContent = 'Envoyer';
                userInput.focus();
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function sendQuickMessage(message) {
            // Si on est en phase de collecte, ne pas utiliser les messages rapides
            // qui pourraient d√©clencher l'agent
            if (currentPhase === 'collecte_info' && currentSessionId) {
                showStatus('‚ö†Ô∏è R√©pondez aux questions pos√©es une par une', 'error');
                return;
            }
            userInput.value = message;
            sendMessage();
        }

        async function resetConversation() {
            try {
                await fetch('/api/reset', {
                    method: 'POST'
                });
                // Cr√©er une nouvelle session
                clearSession();
                lastQuestionAsked = null;
                questionInProgress = false;
                await initializeProfile(true); // Force une nouvelle session
                chatContainer.innerHTML = `
                    <div class="message assistant">
                        <div class="message-bubble">
                            üëã Nouvelle session cr√©√©e. Comment puis-je vous aider ?
                        </div>
                    </div>
                `;
                showStatus('Nouvelle session cr√©√©e', 'success');
            } catch (error) {
                showStatus('Erreur lors de la r√©initialisation', 'error');
            }
        }

        // Fonction pour afficher les informations de session
        function showSessionInfo() {
            if (currentSessionId) {
                const timestamp = localStorage.getItem('spaix_session_timestamp');
                const date = timestamp ? new Date(parseInt(timestamp)).toLocaleString('fr-FR') : 'Inconnu';
                const email = localStorage.getItem('spaix_account_email');
                addMessage(`üìã <strong>Informations de session :</strong><br>Session ID: <code>${currentSessionId}</code><br>Cr√©√©e le: ${date}`, false);
                if (email) {
                    addMessage(`üìß Compte associ√©: ${email}`, false);
                }
                addMessage('üí° <strong>Astuce :</strong> Votre session est sauvegard√©e automatiquement. Vous pouvez fermer et rouvrir cette page, votre session sera restaur√©e automatiquement.', false);
            } else {
                addMessage('Aucune session active', false);
            }
        }

        function showLoginForm() {
            const formDiv = document.createElement('div');
            formDiv.className = 'account-form-container';
            formDiv.innerHTML = `
                <div class="account-form">
                    <h3>üîê Se connecter</h3>
                    <p style="margin-bottom: 20px; color: #666;">Connectez-vous pour retrouver votre progression sauvegard√©e.</p>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">Email :</label>
                        <input type="email" id="loginEmail" placeholder="votre.email@exemple.com" style="width: 100%; padding: 12px; border: 2px solid #e8eaf0; border-radius: 10px; font-size: 14px;">
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">Mot de passe :</label>
                        <input type="password" id="loginPassword" placeholder="Votre mot de passe" style="width: 100%; padding: 12px; border: 2px solid #e8eaf0; border-radius: 10px; font-size: 14px;">
                    </div>
                    <button onclick="login()" class="quick-reply-btn" style="width: 100%;">Se connecter</button>
                </div>
            `;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant';
            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            bubble.appendChild(formDiv);
            messageDiv.appendChild(bubble);
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        async function login() {
            const email = document.getElementById('loginEmail')?.value.trim();
            const password = document.getElementById('loginPassword')?.value;
            
            if (!email || !email.includes('@')) {
                showStatus('‚ùå Veuillez entrer un email valide', 'error');
                return;
            }
            
            if (!password) {
                showStatus('‚ùå Veuillez entrer votre mot de passe', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/account/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    showStatus(`‚ùå ${error.detail || 'Email ou mot de passe incorrect'}`, 'error');
                    return;
                }
                
                const data = await response.json();
                localStorage.setItem('spaix_account_email', email);
                
                // Charger le dernier profil sauvegard√©
                if (data.profiles && Object.keys(data.profiles).length > 0) {
                    const lastSessionId = Object.keys(data.profiles)[Object.keys(data.profiles).length - 1];
                    const profileData = data.profiles[lastSessionId];
                    
                    // Restaurer la session
                    currentSessionId = lastSessionId;
                    currentPhase = profileData.phase || 'collecte_info';
                    saveSessionId(currentSessionId);
                    updatePhaseIndicator(currentPhase, currentSessionId);
                    
                    showStatus('‚úÖ Connexion r√©ussie ! Votre progression a √©t√© restaur√©e.', 'success');
                    addMessage('‚úÖ Vous √™tes connect√©. Votre progression a √©t√© restaur√©e.', false);
                    
                    // Charger le profil complet depuis l'API pour v√©rifier l'√©tat r√©el
                    const profileResponse = await fetch(`/api/profile/${lastSessionId}`);
                    if (profileResponse.ok) {
                        const profile = await profileResponse.json();
                        console.log('üìä Profil charg√© apr√®s connexion:', profile);
                        console.log('   - is_phase1_complete:', profile.is_phase1_complete);
                        console.log('   - phase:', profile.phase);
                        console.log('   - inscription_type:', profile.inscription_type);
                        console.log('   - is_boursier:', profile.is_boursier);
                        console.log('   - is_mineur:', profile.is_mineur);
                        console.log('   - inscrit_autre_etablissement:', profile.inscrit_autre_etablissement);
                        console.log('   - has_jdc:', profile.has_jdc);
                        
                        // Mettre √† jour currentSessionId et currentPhase
                        currentSessionId = lastSessionId;
                        currentPhase = profile.phase || 'collecte_info';
                        saveSessionId(currentSessionId);
                        updatePhaseIndicator(currentPhase, currentSessionId);
                        
                        // V√©rifier si Phase 1 est compl√®te
                        if (profile.is_phase1_complete) {
                            if (profile.phase === 'collecte_info') {
                                // Phase 1 compl√®te mais pas encore pass√©e √† Phase 2
                                showPhase1Summary(profile, true); // true = skip account creation (d√©j√† connect√©)
                            } else if (profile.phase === 'remplissage_formulaire') {
                                // D√©j√† en Phase 2
                                addMessage('üìã Vous √™tes d√©j√† en Phase 2. Continuons le remplissage du formulaire.', false);
                                await startPhase2();
                            }
                        } else {
                            // Phase 1 non compl√®te : continuer avec les questions
                            addMessage('üìã Votre Phase 1 n\'est pas encore compl√®te. Je vais vous poser quelques questions pour d√©terminer les documents n√©cessaires.', false);
                            await startDocumentCheck();
                        }
                    } else {
                        console.error('‚ùå Erreur lors du chargement du profil:', profileResponse.status);
                        // Si erreur, proposer de commencer par Phase 1
                        addMessage('üìã Je vais vous poser quelques questions pour d√©terminer les documents n√©cessaires.', false);
                        await startDocumentCheck();
                    }
                } else {
                    showStatus('‚úÖ Connexion r√©ussie ! Aucune progression sauvegard√©e.', 'success');
                    addMessage('‚úÖ Vous √™tes connect√©. Aucune progression pr√©c√©dente trouv√©e.', false);
                }
                
            } catch (error) {
                showStatus('‚ùå Erreur lors de la connexion', 'error');
            }
        }

        async function validateDocuments() {
            try {
                showStatus('Validation en cours...', '');
                const response = await fetch('/api/validate-documents', {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error('Erreur lors de la validation');
                }

                const data = await response.json();
                
                let message = `üìã Rapport de validation des documents\n\n`;
                message += `Documents requis: ${data.summary.total_required}\n`;
                message += `Documents trouv√©s: ${data.summary.found}\n`;
                message += `Documents valides: ${data.summary.valid}\n`;
                message += `Documents invalides: ${data.summary.invalid}\n`;
                message += `Documents manquants: ${data.summary.missing}\n\n`;

                if (data.missing.length > 0) {
                    message += `‚ö†Ô∏è Documents manquants:\n`;
                    data.missing.forEach(doc => {
                        message += `‚Ä¢ ${doc}\n`;
                    });
                    message += `\n`;
                }

                if (data.documents.length > 0) {
                    message += `üìÑ D√©tails par document:\n\n`;
                    data.documents.forEach(doc => {
                        const status = doc.valid ? '‚úÖ' : '‚ùå';
                        message += `${status} ${doc.document_type}\n`;
                        message += `   Fichier: ${doc.file_path}\n`;
                        message += `   Taille: ${doc.file_size_mb}MB\n`;
                        if (doc.errors && doc.errors.length > 0) {
                            doc.errors.forEach(error => {
                                message += `   ‚ùå Erreur: ${error}\n`;
                            });
                        }
                        if (doc.warnings && doc.warnings.length > 0) {
                            doc.warnings.forEach(warning => {
                                message += `   ‚ö†Ô∏è Avertissement: ${warning}\n`;
                            });
                        }
                        message += `\n`;
                    });
                }

                if (data.valid) {
                    message += `\n‚úÖ Tous vos documents sont valides et pr√™ts pour l'inscription !`;
                } else {
                    message += `\n‚ö†Ô∏è Veuillez corriger les probl√®mes ci-dessus avant de soumettre votre dossier.`;
                }

                addMessage(message, false);
                showStatus(data.valid ? 'Validation termin√©e' : 'Des probl√®mes ont √©t√© d√©tect√©s', data.valid ? 'success' : 'error');

            } catch (error) {
                addMessage('‚ùå Erreur lors de la validation: ' + error.message, false);
                showStatus('Erreur lors de la validation', 'error');
            }
        }

        // Fonction pour d√©tecter les questions oui/non et ajouter des boutons
        function checkAndAddQuickReplies(bubble) {
            const text = bubble.textContent || bubble.innerText || '';
            const lowerText = text.toLowerCase();
            
            // D√©tecter les questions avec choix multiples (format: "(1 - ..., 2 - ..., 3 - ..., 4 - ...)")
            const choicePattern = /\((\d+)\s*-\s*[^,)]+,\s*(\d+)\s*-\s*[^,)]+,\s*(\d+)\s*-\s*[^,)]+,\s*(\d+)\s*-\s*[^)]+\)/i;
            const choiceMatch = text.match(choicePattern);
            
            if (choiceMatch && !bubble.querySelector('.choice-options')) {
                // Extraire les options
                const options = [];
                const fullMatch = choiceMatch[0];
                const optionPattern = /(\d+)\s*-\s*([^,)]+)/g;
                let match;
                while ((match = optionPattern.exec(fullMatch)) !== null) {
                    options.push({
                        value: match[1],
                        label: match[2].trim()
                    });
                }
                
                if (options.length > 0) {
                    const choiceContainer = document.createElement('div');
                    choiceContainer.className = 'choice-options';
                    
                    const radioGroupName = 'choice_' + Date.now();
                    let submitBtn;
                    
                    options.forEach((option, index) => {
                        const optionDiv = document.createElement('div');
                        optionDiv.className = 'choice-option';
                        
                        const radio = document.createElement('input');
                        radio.type = 'radio';
                        radio.name = radioGroupName;
                        radio.id = radioGroupName + '_' + index;
                        radio.value = option.value;
                        
                        const label = document.createElement('label');
                        label.htmlFor = radioGroupName + '_' + index;
                        label.textContent = `${option.value} - ${option.label}`;
                        
                        // G√©rer la s√©lection visuelle
                        radio.addEventListener('change', () => {
                            document.querySelectorAll(`input[name="${radioGroupName}"]`).forEach(r => {
                                r.closest('.choice-option').classList.remove('selected');
                            });
                            radio.closest('.choice-option').classList.add('selected');
                            if (submitBtn) submitBtn.disabled = false;
                        });
                        
                        optionDiv.appendChild(radio);
                        optionDiv.appendChild(label);
                        choiceContainer.appendChild(optionDiv);
                    });
                    
                    submitBtn = document.createElement('button');
                    submitBtn.className = 'choice-submit-btn';
                    submitBtn.textContent = 'Valider';
                    submitBtn.disabled = true;
                    submitBtn.onclick = () => {
                        const selected = document.querySelector(`input[name="${radioGroupName}"]:checked`);
                        if (selected) {
                            const selectedValue = selected.value;
                            
                            // Envoyer la r√©ponse
                            userInput.value = selectedValue;
                            sendMessage();
                        }
                    };
                    
                    choiceContainer.appendChild(submitBtn);
                    bubble.appendChild(choiceContainer);
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                    return; // Ne pas continuer avec les boutons Oui/Non
                }
            }
            
            // D√©tecter les questions oui/non
            const yesNoPatterns = [
                /pouvez-vous me confirmer/i,
                /pouvez-vous confirmer/i,
                /confirmer/i,
                /√™tes-vous/i,
                /avez-vous/i,
                /souhaitez-vous/i,
                /voulez-vous/i,
                /est-ce que/i,
                /avez-vous d√©j√† rassembl√©/i,
                /avez-vous rassembl√©/i,
                /rassembl√©s/i,
                /rassembl√©/i
            ];
            
            // Mots-cl√©s qui indiquent une question oui/non
            const yesNoKeywords = [
                'confirmer',
                '√™tes-vous',
                'avez-vous',
                'rassembl√©s',
                'rassembl√©',
                'rassembl√© tous',
                'rassembl√©s tous',
                'rassembl√© tous les documents',
                'si oui',
                'sinon'
            ];
            
            const hasQuestionMark = text.includes('?');
            const hasInterrogative = yesNoPatterns.some(pattern => pattern.test(text));
            const hasYesNoKeyword = yesNoKeywords.some(keyword => lowerText.includes(keyword));
            const hasConditional = lowerText.includes('si oui') || lowerText.includes('sinon');
            
            // D√©tecter si c'est une question oui/non
            const isYesNoQuestion = (hasQuestionMark || hasInterrogative || hasConditional) && 
                                   (hasYesNoKeyword || hasConditional || lowerText.includes('rassembl'));
            
            if (isYesNoQuestion && !bubble.querySelector('.quick-reply-buttons')) {
                const replyContainer = document.createElement('div');
                replyContainer.className = 'quick-reply-buttons';
                replyContainer.style.marginTop = '12px';
                
                const yesBtn = document.createElement('button');
                yesBtn.className = 'quick-reply-btn';
                yesBtn.textContent = 'Oui';
                yesBtn.onclick = () => {
                    userInput.value = 'Oui';
                    sendMessage();
                };
                
                const noBtn = document.createElement('button');
                noBtn.className = 'quick-reply-btn secondary';
                noBtn.textContent = 'Non';
                noBtn.onclick = () => {
                    userInput.value = 'Non';
                    sendMessage();
                };
                
                replyContainer.appendChild(yesBtn);
                replyContainer.appendChild(noBtn);
                bubble.appendChild(replyContainer);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }

        // Fonctions de gestion de session
        function saveSessionId(sessionId) {
            if (sessionId) {
                localStorage.setItem('spaix_session_id', sessionId);
                localStorage.setItem('spaix_session_timestamp', Date.now().toString());
            }
        }

        function getSavedSessionId() {
            return localStorage.getItem('spaix_session_id');
        }

        function clearSession() {
            localStorage.removeItem('spaix_session_id');
            localStorage.removeItem('spaix_session_timestamp');
            currentSessionId = null;
        }

        async function loadExistingProfile(sessionId, skipIfPhase1Complete = false) {
            try {
                // V√âRIFICATION CRITIQUE : Ne JAMAIS restaurer une session si pas de compte
                const savedEmail = localStorage.getItem('spaix_account_email');
                if (!savedEmail || savedEmail.trim() === '' || savedEmail === 'null' || savedEmail === 'undefined') {
                    console.log('‚è≠Ô∏è Pas de compte valide, on ne restaure pas la session');
                    return false;
                }
                
                console.log('üìÇ Chargement du profil pour session:', sessionId);
                const response = await fetch(`/api/profile/${sessionId}`);
                if (response.ok) {
                    const profile = await response.json();
                    console.log('üìä Profil charg√©:', profile);
                    currentSessionId = sessionId;
                    // Si le profil n'est pas complet (Phase 1), forcer collecte_info
                    if (!profile.is_phase1_complete && profile.phase === 'remplissage_formulaire') {
                        console.log('‚ö†Ô∏è Profil incomplet en remplissage_formulaire, passage √† collecte_info');
                        currentPhase = 'collecte_info';
                    } else {
                        currentPhase = profile.phase;
                    }
                    console.log('‚úÖ Phase d√©finie √†:', currentPhase);
                    updatePhaseIndicator(currentPhase, currentSessionId);
                    return true;
                } else {
                    console.error('‚ùå Erreur HTTP lors du chargement:', response.status, response.statusText);
                    const errorText = await response.text();
                    console.error('‚ùå D√©tails:', errorText);
                }
            } catch (error) {
                console.error('‚ùå Erreur lors du chargement du profil:', error);
            }
            return false;
        }

        // Cr√©er ou restaurer un profil au chargement de la page
        async function initializeProfile(forceNew = false, skipRestoreIfNoAccount = false) {
            // Si on force une nouvelle session, supprimer l'ancienne
            if (forceNew) {
                console.log('üîÑ Cr√©ation d\'une nouvelle session (rechargement forc√©)');
                clearSession();
            } else {
                // Si skipRestoreIfNoAccount est true, v√©rifier d'abord s'il y a un compte
                if (skipRestoreIfNoAccount) {
                    const savedEmail = localStorage.getItem('spaix_account_email');
                    if (!savedEmail) {
                        console.log('   - Pas de compte, ne pas restaurer la session');
                        clearSession();
                        // Cr√©er une nouvelle session directement
                        if (!currentSessionId) {
                            try {
                                console.log('üìù Cr√©ation d\'un nouveau profil (pas de compte)...');
                                const response = await fetch('/api/profile/start', {
                                    method: 'POST'
                                });
                                const data = await response.json();
                                currentSessionId = data.session_id;
                                currentPhase = data.phase;
                                saveSessionId(currentSessionId);
                                updatePhaseIndicator(currentPhase, currentSessionId);
                                console.log('‚úÖ Nouveau profil cr√©√©:', currentSessionId);
                                return;
                            } catch (error) {
                                console.error('‚ùå Erreur lors de la cr√©ation du profil:', error);
                            }
                        }
                        return;
                    }
                }
                
                // D'abord, essayer de restaurer une session existante
                const savedSessionId = getSavedSessionId();
                if (savedSessionId) {
                    const loaded = await loadExistingProfile(savedSessionId);
                    if (loaded) {
                        console.log('‚úÖ Session restaur√©e:', savedSessionId);
                        addMessage('üëã Bon retour ! Votre session pr√©c√©dente a √©t√© restaur√©e.', false);
                        return;
                    } else {
                        // Session invalide, la supprimer
                        clearSession();
                    }
                }
            }
            
            // Cr√©er un nouveau profil
            if (!currentSessionId) {
                try {
                    console.log('üìù Cr√©ation d\'un nouveau profil...');
                    const response = await fetch('/api/profile/start', {
                        method: 'POST'
                    });
                    const data = await response.json();
                    currentSessionId = data.session_id;
                    currentPhase = data.phase;
                    saveSessionId(currentSessionId);
                    updatePhaseIndicator(currentPhase, currentSessionId);
                    console.log('‚úÖ Nouveau profil cr√©√©:', currentSessionId);
                } catch (error) {
                    console.error('‚ùå Erreur lors de la cr√©ation du profil:', error);
                }
            }
        }

        // V√©rifier si on doit cr√©er une nouvelle session
        // Option 1: Via param√®tre URL ?new=true
        const urlParams = new URLSearchParams(window.location.search);
        const forceNewSession = urlParams.get('new') === 'true';
        
        // Option 2: D√©tecter un rechargement forc√© (Cmd+Shift+R)
        // On ne peut pas d√©tecter directement Cmd+Shift+R, mais on peut v√©rifier
        // si c'est un rechargement depuis le cache (performance.navigation.type === 1)
        // ou si l'utilisateur a explicitement demand√© une nouvelle session
        const isReload = performance.navigation.type === 1; // TYPE_RELOAD
        const shouldCreateNewSession = forceNewSession || (isReload && !localStorage.getItem('spaix_keep_session'));
        
        // Ne pas initialiser automatiquement le profil au chargement
        // L'utilisateur choisira entre Phase 1 ou Phase 2 via les boutons
        // initializeProfile(shouldCreateNewSession);
        
        // Si une nouvelle session a √©t√© cr√©√©e, nettoyer l'URL
        if (forceNewSession) {
            window.history.replaceState({}, document.title, window.location.pathname);
        }

        // Afficher le message de bienvenue avec les deux options
        // (d√©j√† affich√© dans le HTML, mais on peut ajouter un message si n√©cessaire)
        
        // Focus sur l'input au chargement
        userInput.focus();

        // Gestion du syst√®me de profils et phases
        let currentSessionId = null;
        let currentPhase = 'collecte_info'; // ou 'remplissage_formulaire'

        function updatePhaseIndicator(phase, sessionId) {
            const indicator = document.getElementById('phaseIndicator');
            const phase1Badge = document.getElementById('phase1Badge');
            const phase2Badge = document.getElementById('phase2Badge');
            const sessionInfo = document.getElementById('sessionInfo');
            
            // D√©sactiver les boutons rapides pendant la phase de collecte
            const quickActionBtns = ['btnPieces', 'btnCodes', 'btnAide'];
            quickActionBtns.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    if (phase === 'collecte_info' && sessionId) {
                        btn.style.opacity = '0.5';
                        btn.style.pointerEvents = 'none';
                    } else {
                        btn.style.opacity = '1';
                        btn.style.pointerEvents = 'auto';
                    }
                }
            });
            
            if (sessionId) {
                indicator.style.display = 'flex';
                sessionInfo.textContent = `Session: ${sessionId.substring(0, 8)}...`;
                
                if (phase === 'collecte_info') {
                    phase1Badge.style.display = 'inline-block';
                    phase2Badge.style.display = 'none';
                } else if (phase === 'remplissage_formulaire') {
                    phase1Badge.style.display = 'none';
                    phase2Badge.style.display = 'inline-block';
                }
            } else {
                indicator.style.display = 'none';
            }
            
            // IMPORTANT : Ne PAS restaurer currentSessionId depuis sessionId si l'utilisateur n'a pas de compte
            // Cette fonction ne doit QUE mettre √† jour l'affichage, pas restaurer la session
        }

        async function startDocumentCheck(forceNewSession = false) {
            try {
                console.log('üìã startDocumentCheck() appel√©, forceNewSession:', forceNewSession);
                console.log('   - currentSessionId avant:', currentSessionId);
                console.log('   - localStorage spaix_session_id avant:', localStorage.getItem('spaix_session_id'));
                
                // R√©initialiser les variables de suivi
                lastQuestionAsked = null;
                questionInProgress = false;
                
                // Si on force une nouvelle session, TOUJOURS cr√©er une nouvelle session
                if (forceNewSession) {
                    console.log('üîÑ Forcer cr√©ation d\'une nouvelle session');
                    // NETTOYER COMPL√àTEMENT avant de cr√©er une nouvelle session
                    clearSession();
                    currentSessionId = null; // S'assurer que currentSessionId est null
                    currentPhase = 'collecte_info';
                    
                    // Double v√©rification : supprimer toute trace de session dans localStorage
                    localStorage.removeItem('spaix_session_id');
                    localStorage.removeItem('spaix_session_timestamp');
                    
                    // Triple v√©rification : s'assurer que currentSessionId est vraiment null
                    if (currentSessionId) {
                        console.log('   - ‚ö†Ô∏è currentSessionId encore d√©fini, forcer √† null');
                        currentSessionId = null;
                    }
                    
                    console.log('   - Session nettoy√©e, cr√©ation d\'une nouvelle...');
                    console.log('   - currentSessionId apr√®s nettoyage:', currentSessionId);
                    console.log('   - localStorage spaix_session_id apr√®s nettoyage:', localStorage.getItem('spaix_session_id'));
                    
                    const response = await fetch('/api/profile/start', {
                        method: 'POST'
                    });
                    const data = await response.json();
                    currentSessionId = data.session_id;
                    console.log('   - ‚úÖ Nouvelle session cr√©√©e:', currentSessionId);
                    saveSessionId(currentSessionId);
                } else if (!currentSessionId) {
                    // Pas de session : en cr√©er une nouvelle
                    const response = await fetch('/api/profile/start', {
                        method: 'POST'
                    });
                    const data = await response.json();
                    currentSessionId = data.session_id;
                    saveSessionId(currentSessionId);
                } else {
                    // V√©rifier si la session actuelle a une Phase 1 compl√®te
                    // Si oui, cr√©er une nouvelle session pour recommencer
                    try {
                        const profileResponse = await fetch(`/api/profile/${currentSessionId}`);
                        if (profileResponse.ok) {
                            const profile = await profileResponse.json();
                            if (profile.is_phase1_complete) {
                                // Phase 1 d√©j√† compl√®te : cr√©er une nouvelle session
                                console.log('üîÑ Phase 1 d√©j√† compl√®te, cr√©ation d\'une nouvelle session');
                                clearSession();
                                currentSessionId = null; // S'assurer que currentSessionId est null
                                const response = await fetch('/api/profile/start', {
                                    method: 'POST'
                                });
                                const data = await response.json();
                                currentSessionId = data.session_id;
                                saveSessionId(currentSessionId);
                            }
                        }
                    } catch (error) {
                        console.error('Erreur lors de la v√©rification du profil:', error);
                    }
                }
                
                currentPhase = 'collecte_info';
                
                // V√âRIFICATION CRITIQUE : S'assurer que la nouvelle session n'est PAS compl√®te
                // Une nouvelle session ne devrait JAMAIS √™tre compl√®te
                console.log('üîç V√©rification finale - currentSessionId:', currentSessionId);
                console.log('üîç V√©rification finale - currentPhase:', currentPhase);
                
                // V√©rifier le profil pour s'assurer qu'il n'est pas compl√®te
                if (currentSessionId) {
                    try {
                        const verifyResponse = await fetch(`/api/profile/${currentSessionId}`);
                        if (verifyResponse.ok) {
                            const verifyProfile = await verifyResponse.json();
                            console.log('üîç Profil v√©rifi√© apr√®s cr√©ation:', verifyProfile);
                            console.log('üîç is_phase1_complete:', verifyProfile.is_phase1_complete);
                            
                            // Si le profil est compl√®te, c'est une erreur - cr√©er une nouvelle session
                            if (verifyProfile.is_phase1_complete) {
                                console.error('‚ùå ERREUR: Nouvelle session d√©tect√©e comme compl√®te !');
                                console.error('   - Session ID:', currentSessionId);
                                console.error('   - Profil:', verifyProfile);
                                // Cr√©er une nouvelle session
                                clearSession();
                                currentSessionId = null;
                                const newResponse = await fetch('/api/profile/start', {
                                    method: 'POST'
                                });
                                const newData = await newResponse.json();
                                currentSessionId = newData.session_id;
                                saveSessionId(currentSessionId);
                                console.log('‚úÖ Nouvelle session cr√©√©e apr√®s erreur:', currentSessionId);
                            }
                        }
                    } catch (error) {
                        console.error('‚ùå Erreur lors de la v√©rification du profil:', error);
                    }
                }
                
                updatePhaseIndicator(currentPhase, currentSessionId);
                
                addMessage('üìã Parfait ! Je vais vous poser quelques questions pour d√©terminer exactement quels documents vous devez fournir.', false);
                addMessage('Je vais poser une question √† la fois, r√©pondez simplement √† chacune.', false);
                addMessage('', false);
                
                // Poser la premi√®re question directement (sans passer par l'agent)
                lastQuestionAsked = 'inscription_type';
                addMessage('Pour commencer, √™tes-vous en <strong>premi√®re inscription</strong> ou en <strong>r√©inscription</strong> ?', false, [
                    { text: 'Premi√®re inscription' },
                    { text: 'R√©inscription LAP', secondary: true },
                    { text: 'R√©inscription Master', secondary: true },
                    { text: 'R√©inscription Prep\' Concours', secondary: true }
                ]);
                addMessage('(Si r√©inscription, pr√©cisez : LAP, Master, ou Prep\' Concours)', false);
                
                showStatus('Mode : D√©couverte des documents n√©cessaires', 'success');
            } catch (error) {
                showStatus('Erreur lors du d√©marrage', 'error');
            }
        }

        async function startForm() {
            try {
                console.log('üöÄ startForm() appel√© - "Commencer mon inscription compl√®te"');
                
                // R√©initialiser les variables de suivi
                lastQuestionAsked = null;
                questionInProgress = false;
                
                // COMPORTEMENT ATTENDU pour "Commencer mon inscription compl√®te" :
                // 1. Demander si l'utilisateur a d√©j√† un compte
                // 2. Si OUI : demander de se connecter, puis v√©rifier Phase 1
                //    - Si Phase 1 compl√®te ‚Üí Phase 2
                //    - Si Phase 1 non compl√®te ‚Üí Phase 1
                // 3. Si NON : commencer par la Phase 1
                
                // V√©rifier si l'utilisateur a d√©j√† un compte connect√©
                const savedEmail = localStorage.getItem('spaix_account_email');
                const hasAccount = savedEmail && savedEmail.trim() !== '' && savedEmail !== 'null' && savedEmail !== 'undefined';
                
                console.log('   - savedEmail:', savedEmail);
                console.log('   - hasAccount:', hasAccount);
                
                if (hasAccount) {
                    // L'utilisateur a un compte : demander de se connecter pour r√©cup√©rer sa progression
                    console.log('   - ‚úÖ Compte d√©tect√©, demander de se connecter');
                    addMessage('üîê Vous avez d√©j√† un compte. Pour acc√©der √† votre progression sauvegard√©e, veuillez vous connecter.', false);
                    addMessage('', false);
                    addMessage('Souhaitez-vous :', false, [
                        { text: 'Se connecter' },
                        { text: 'Commencer par la Phase 1', secondary: true }
                    ]);
                    lastQuestionAsked = 'phase2_need_login';
                    return;
                } else {
                    // Pas de compte : demander si l'utilisateur a d√©j√† un compte
                    console.log('   - ‚ùå Pas de compte d√©tect√©, demander si l\'utilisateur a un compte');
                    addMessage('üìã Pour commencer votre inscription compl√®te, avez-vous d√©j√† un compte ?', false);
                    addMessage('', false);
                    addMessage('Si oui, vous pourrez vous connecter pour r√©cup√©rer votre progression. Si non, nous commencerons par la Phase 1.', false, [
                        { text: 'Oui, j\'ai un compte' },
                        { text: 'Non, je n\'ai pas de compte', secondary: true }
                    ]);
                    lastQuestionAsked = 'has_account_check';
                    return;
                }
                
            } catch (error) {
                console.error('Erreur lors du d√©marrage:', error);
                showStatus('Erreur lors du d√©marrage', 'error');
            }
        }

        async function checkProfileStatus() {
            if (!currentSessionId) return;
            
            try {
                const response = await fetch(`/api/profile/${currentSessionId}`);
                const profile = await response.json();
                
                currentPhase = profile.phase;
                
                // Si la phase 1 est compl√®te mais qu'on est encore en phase 1, afficher les documents
                if (profile.phase === 'collecte_info' && 
                    profile.inscription_type && 
                    profile.is_boursier !== null && 
                    profile.is_mineur !== null && 
                    profile.inscrit_autre_etablissement !== null && 
                    profile.has_jdc !== null) {
                    
                    // Calculer les documents et passer √† la phase 2
                    const updateResponse = await fetch(`/api/profile/${currentSessionId}/phase2`, {
                        method: 'POST'
                    });
                    const updateData = await updateResponse.json();
                    
                    // Afficher le r√©sum√© avec les documents recalcul√©s
                    showPhase1Summary(updateData.profile);
                }
                
                return profile;
            } catch (error) {
                console.error('Erreur chargement profil:', error);
                return null;
            }
        }

        function showPhase1Summary(profile, skipAccountCreation = false) {
            // Ne pas passer directement √† la phase 2, demander confirmation
            addMessage('‚úÖ Phase 1 termin√©e ! Voici les documents que vous devez fournir :', false);
            addMessage('', false);
            
            const docList = document.createElement('div');
            docList.className = 'documents-list';
            docList.id = 'documentsList_' + Date.now();
            
            const header = document.createElement('div');
            header.className = 'documents-list-header';
            
            const title = document.createElement('div');
            title.className = 'documents-list-title';
            title.textContent = 'Documents √† fournir';
            
            const exportButtons = document.createElement('div');
            exportButtons.className = 'export-buttons';
            exportButtons.innerHTML = `
                <button class="export-btn" onclick="exportToCSV('${docList.id}')">
                    üì• T√©l√©charger CSV
                </button>
                <button class="export-btn" onclick="exportToEmail('${docList.id}')">
                    ‚úâÔ∏è Envoyer par Email
                </button>
            `;
            
            header.appendChild(title);
            header.appendChild(exportButtons);
            
            const ul = document.createElement('ul');
            profile.required_documents.forEach((doc, index) => {
                const li = document.createElement('li');
                li.textContent = doc;
                li.setAttribute('data-doc', doc);
                ul.appendChild(li);
            });
            
            docList.appendChild(header);
            docList.appendChild(ul);
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant';
            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            bubble.style.maxWidth = '90%';
            bubble.appendChild(docList);
            messageDiv.appendChild(bubble);
            chatContainer.appendChild(messageDiv);
            
            // Scroller pour voir la liste des documents
            setTimeout(() => {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }, 100);
            
            addMessage('', false);
            
            // V√©rifier si l'utilisateur a d√©j√† un compte
            const savedEmail = localStorage.getItem('spaix_account_email');
            const hasAccount = savedEmail && savedEmail.trim() !== '';
            
            console.log('üîç showPhase1Summary - skipAccountCreation:', skipAccountCreation);
            console.log('üîç showPhase1Summary - savedEmail:', savedEmail);
            console.log('üîç showPhase1Summary - hasAccount:', hasAccount);
            
            // TOUJOURS proposer la cr√©ation de compte si skipAccountCreation est false
            // sauf si l'utilisateur a vraiment un compte connect√©
            if (skipAccountCreation) {
                // L'utilisateur est d√©j√† connect√© (skipAccountCreation = true)
                // Proposer directement la Phase 2
                console.log('‚úÖ Utilisateur d√©j√† connect√©, skip cr√©ation de compte');
                setTimeout(() => {
                    lastQuestionAsked = 'phase2_confirm';
                    addMessage('üìã Souhaitez-vous maintenant passer √† la <strong>Phase 2</strong> : le remplissage du formulaire d\'inscription ?', false, [
                        { text: 'Oui, commencer la Phase 2' },
                        { text: 'Non, pas maintenant', secondary: true }
                    ]);
                    
                    // Scroller √† nouveau apr√®s la question
                    setTimeout(() => {
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                    }, 100);
                }, 500);
            } else {
                // Pas de compte ou skipAccountCreation = false : TOUJOURS proposer de cr√©er un compte
                console.log('üíæ Pas de compte d√©tect√©, proposition de cr√©ation de compte');
                setTimeout(() => {
                    lastQuestionAsked = 'create_account';
                    addMessage('üíæ Pour sauvegarder votre progression et pouvoir y revenir plus tard, souhaitez-vous <strong>cr√©er un compte</strong> ?', false, [
                        { text: 'Oui, cr√©er un compte' },
                        { text: 'Non, continuer sans compte', secondary: true }
                    ]);
                    
                    // Scroller √† nouveau apr√®s la question
                    setTimeout(() => {
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                    }, 100);
                }, 500);
            }
        }

        function showAccountCreationForm() {
            const formDiv = document.createElement('div');
            formDiv.className = 'account-form-container';
            formDiv.innerHTML = `
                <div class="account-form">
                    <h3>üìù Cr√©er un compte</h3>
                    <p style="margin-bottom: 20px; color: #666;">Cr√©ez un compte pour sauvegarder votre progression et y revenir plus tard.</p>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">Email :</label>
                        <input type="email" id="accountEmail" placeholder="votre.email@exemple.com" style="width: 100%; padding: 12px; border: 2px solid #e8eaf0; border-radius: 10px; font-size: 14px;">
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">Mot de passe :</label>
                        <input type="password" id="accountPassword" placeholder="Minimum 6 caract√®res" style="width: 100%; padding: 12px; border: 2px solid #e8eaf0; border-radius: 10px; font-size: 14px;">
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="createAccount()" class="quick-reply-btn" style="flex: 1;">Cr√©er le compte</button>
                        <button onclick="skipAccountCreation()" class="quick-reply-btn secondary" style="flex: 1;">Passer</button>
                    </div>
                </div>
            `;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant';
            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            bubble.appendChild(formDiv);
            messageDiv.appendChild(bubble);
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        async function createAccount() {
            const email = document.getElementById('accountEmail')?.value.trim();
            const password = document.getElementById('accountPassword')?.value;
            
            if (!email || !email.includes('@')) {
                showStatus('‚ùå Veuillez entrer un email valide', 'error');
                return;
            }
            
            if (!password || password.length < 6) {
                showStatus('‚ùå Le mot de passe doit contenir au moins 6 caract√®res', 'error');
                return;
            }
            
            try {
                // Cr√©er le compte
                const createResponse = await fetch('/api/account/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                if (!createResponse.ok) {
                    const error = await createResponse.json();
                    showStatus(`‚ùå ${error.detail || 'Erreur lors de la cr√©ation du compte'}`, 'error');
                    return;
                }
                
                // Sauvegarder le profil dans le compte
                if (currentSessionId) {
                    const profile = await checkProfileStatus();
                    if (profile) {
                        await fetch(`/api/account/${encodeURIComponent(email)}/save-profile`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                session_id: currentSessionId,
                                profile_data: profile
                            })
                        });
                    }
                }
                
                // Sauvegarder l'email dans localStorage
                localStorage.setItem('spaix_account_email', email);
                
                showStatus('‚úÖ Compte cr√©√© avec succ√®s !', 'success');
                addMessage('‚úÖ Votre compte a √©t√© cr√©√©. Vous pouvez maintenant vous connecter avec votre email et mot de passe pour retrouver votre progression.', false);
                
                // Proposer de passer √† la Phase 2
                setTimeout(() => {
                    lastQuestionAsked = 'phase2_confirm';
                    addMessage('üìã Souhaitez-vous maintenant passer √† la <strong>Phase 2</strong> : le remplissage du formulaire d\'inscription ?', false, [
                        { text: 'Oui, commencer la Phase 2' },
                        { text: 'Non, pas maintenant', secondary: true }
                    ]);
                }, 1000);
                
            } catch (error) {
                showStatus('‚ùå Erreur lors de la cr√©ation du compte', 'error');
            }
        }

        function skipAccountCreation() {
            addMessage('D\'accord, vous continuerez sans compte. Votre progression sera sauvegard√©e localement.', false);
            
            // Proposer de passer √† la Phase 2
            setTimeout(() => {
                lastQuestionAsked = 'phase2_confirm';
                addMessage('üìã Souhaitez-vous maintenant passer √† la <strong>Phase 2</strong> : le remplissage du formulaire d\'inscription ?', false, [
                    { text: 'Oui, commencer la Phase 2' },
                    { text: 'Non, pas maintenant', secondary: true }
                ]);
            }, 500);
        }

        async function startPhase2() {
            if (!currentSessionId) return;
            
            try {
                // V√©rifier si l'utilisateur a d√©j√† un compte
                const savedEmail = localStorage.getItem('spaix_account_email');
                const hasAccount = savedEmail && savedEmail.trim() !== '' && savedEmail !== 'null' && savedEmail !== 'undefined';
                
                // Si l'utilisateur n'a pas de compte, demander s'il veut en cr√©er un
                if (!hasAccount) {
                    addMessage('üìù Pour sauvegarder votre progression dans la Phase 2, souhaitez-vous cr√©er un compte ?', false, [
                        { text: 'Oui, cr√©er un compte' },
                        { text: 'Non, continuer sans compte', secondary: true }
                    ]);
                    lastQuestionAsked = 'phase2_account_creation';
                    // Ne pas continuer tant que l'utilisateur n'a pas r√©pondu
                    return;
                }
                
                // L'utilisateur a d√©j√† un compte : continuer directement avec la Phase 2
                console.log('‚úÖ Utilisateur d√©j√† connect√©, passage direct √† la Phase 2');
                const response = await fetch(`/api/profile/${currentSessionId}/phase2`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                currentPhase = 'remplissage_formulaire';
                updatePhaseIndicator(currentPhase, currentSessionId);
                
                addMessage('üìã Parfait ! Passons √† la Phase 2 : le remplissage du formulaire d\'inscription.', false);
                addMessage('Je vais vous poser des questions pour remplir chaque champ du formulaire.', false);
                addMessage('', false);
                addMessage('Commen√ßons par vos informations personnelles. Quel est votre nom de famille ?', false);
            } catch (error) {
                showStatus('Erreur lors du d√©marrage de la Phase 2', 'error');
            }
        }

        // Fonctions d'export
        function getDocumentsText(listId) {
            const list = document.getElementById(listId);
            if (!list) return '';
            
            const items = list.querySelectorAll('li');
            return Array.from(items).map((li, index) => 
                `${index + 1}. ${li.textContent.trim()}`
            ).join('\n');
        }

        async function exportToCSV(listId) {
            try {
                if (!currentSessionId) {
                    showStatus('‚ùå Aucune session active', 'error');
                    return;
                }
                
                // Utiliser encodeURIComponent pour s'assurer que le format est bien pass√©
                const url = `/api/profile/${currentSessionId}/export?format=csv`;
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'text/csv, application/json'
                    }
                });
                
                // V√©rifier si la r√©ponse est OK
                if (!response.ok) {
                    // Essayer de lire comme JSON pour l'erreur
                    try {
                        const errorData = await response.json();
                        showStatus(`‚ùå Erreur: ${errorData.detail || 'Erreur lors du t√©l√©chargement'}`, 'error');
                    } catch (e) {
                        showStatus(`‚ùå Erreur ${response.status}: ${response.statusText}`, 'error');
                    }
                    return;
                }
                
                // V√©rifier le type de contenu
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('json')) {
                    // C'est une erreur JSON, pas un CSV
                    const errorData = await response.json();
                    showStatus(`‚ùå Erreur: ${errorData.detail || 'Format non support√©'}`, 'error');
                    return;
                }
                
                const blob = await response.blob();
                
                const blobUrl = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = blobUrl;
                a.download = 'documents-a-fournir.csv';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(blobUrl);
                
                showStatus('‚úÖ CSV t√©l√©charg√© !', 'success');
            } catch (error) {
                console.error('Erreur export CSV:', error);
                showStatus('‚ùå Erreur lors de l\'export CSV: ' + error.message, 'error');
            }
        }

        async function exportToEmail(listId) {
            try {
                if (!currentSessionId) {
                    showStatus('‚ùå Aucune session active', 'error');
                    return;
                }
                
                const response = await fetch(`/api/profile/${currentSessionId}/export?format=email`);
                const emailData = await response.json();
                
                const subject = encodeURIComponent(emailData.subject);
                const body = encodeURIComponent(emailData.body);
                
                window.location.href = `mailto:?subject=${subject}&body=${body}`;
                showStatus('üìß Email pr√©par√©', 'success');
            } catch (error) {
                // Fallback
                const text = getDocumentsText(listId);
                const subject = encodeURIComponent('Documents √† fournir - Sciences Po Aix');
                const body = encodeURIComponent(
                    `Bonjour,\n\nVoici la liste des documents √† fournir pour mon inscription √† Sciences Po Aix :\n\n${text}\n\nCordialement`
                );
                window.location.href = `mailto:?subject=${subject}&body=${body}`;
                showStatus('üìß Email pr√©par√©', 'success');
            }
        }


        async function updateProfile(field, value) {
            if (!currentSessionId) {
                console.error('‚ùå updateProfile: Pas de currentSessionId');
                return null;
            }
            
            try {
                console.log(`üîÑ updateProfile appel√©: ${field} = ${value} pour session ${currentSessionId}`);
                const requestBody = { [field]: value };
                console.log('üì§ Corps de la requ√™te:', requestBody);
                
                const response = await fetch(`/api/profile/${currentSessionId}/update`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });
                
                console.log('üì• Statut de la r√©ponse:', response.status, response.statusText);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`‚ùå Erreur HTTP ${response.status}:`, errorText);
                    return null;
                }
                
                const data = await response.json();
                console.log('üìä R√©ponse updateProfile compl√®te:', data);
                
                // V√©rifier que la mise √† jour a bien √©t√© effectu√©e
                if (data && data.profile) {
                    console.log(`‚úÖ Mise √† jour confirm√©e: ${field} = ${data.profile[field]}`);
                    console.log('üìã Profil complet apr√®s mise √† jour:', data.profile);
                } else {
                    console.error('‚ùå R√©ponse updateProfile sans profile:', data);
                }
                
                // V√©rifier si on peut passer √† la phase 2
                if (data.phase1_complete && currentPhase === 'collecte_info') {
                    console.log('‚úÖ Phase 1 compl√®te, passage √† la phase 2');
                    // Passer automatiquement √† la phase 2 et r√©cup√©rer le profil avec documents recalcul√©s
                    const phase2Response = await fetch(`/api/profile/${currentSessionId}/phase2`, {
                        method: 'POST'
                    });
                    const phase2Data = await phase2Response.json();
                    // Utiliser le profil de phase2 qui a les documents recalcul√©s
                    showPhase1Summary(phase2Data.profile);
                    return data;
                }
                
                // Si la phase 1 n'est pas compl√®te, on continue avec les questions
                console.log('üìä Phase 1 non compl√®te, continuation des questions');
                console.log('   - phase1_complete:', data.phase1_complete);
                console.log('   - currentPhase:', currentPhase);
                console.log('   - inscription_type:', data.profile?.inscription_type);
                
                // TOUJOURS r√©initialiser questionInProgress apr√®s une mise √† jour
                // pour permettre la question suivante
                questionInProgress = false;
                console.log('üîì questionInProgress = false (apr√®s updateProfile)');
                
                // Si on vient de mettre √† jour inscription_type, r√©initialiser lastQuestionAsked
                // pour permettre la question suivante
                if (field === 'inscription_type') {
                    lastQuestionAsked = null;
                    console.log('üîÑ lastQuestionAsked r√©initialis√© (inscription_type mis √† jour)');
                }
                
                return data;
            } catch (error) {
                console.error('Erreur mise √† jour profil:', error);
                return null;
            }
        }

        // Fonction pour d√©tecter et mettre √† jour le profil automatiquement
        async function detectAndUpdateProfile(message) {
            if (!currentSessionId) return false;
            
            // Si on n'est pas en phase collecte_info, forcer le passage √† cette phase
            if (currentPhase !== 'collecte_info') {
                console.log('‚ö†Ô∏è Phase incorrecte d√©tect√©e:', currentPhase, '- Passage √† collecte_info');
                currentPhase = 'collecte_info';
                updatePhaseIndicator(currentPhase, currentSessionId);
            }
            
            const lowerMessage = message.toLowerCase().trim();
            let updated = false;
            
            // R√©cup√©rer le profil pour savoir quelle question est en cours
            const profile = await checkProfileStatus();
            if (!profile) return false;
            
            // D√©tection bas√©e sur la derni√®re question pos√©e
            // Si on attend une r√©ponse √† une question sp√©cifique, d√©tecter selon le contexte
            
            // 1. D√©tection type d'inscription
            if (!profile.inscription_type) {
                // D√©tection prioritaire : types de r√©inscription sp√©cifiques
                if (lowerMessage.includes('prep') && (lowerMessage.includes('concours') || lowerMessage.includes('r√©inscription') || lowerMessage.includes('reinscription') || lowerMessage.includes('prep'))) {
                    await updateProfile('inscription_type', 'prep_concours');
                    updated = true;
                } else if (lowerMessage.includes('lap') && (lowerMessage.includes('r√©inscription') || lowerMessage.includes('reinscription') || lowerMessage === 'lap')) {
                    await updateProfile('inscription_type', 'lap');
                    updated = true;
                } else if (lowerMessage.includes('master') || 
                          lowerMessage === 'master' || 
                          lowerMessage.includes('r√©inscription master') || 
                          lowerMessage.includes('reinscription master') ||
                          lowerMessage === 'r√©inscription master' ||
                          lowerMessage === 'reinscription master') {
                    console.log('‚úÖ D√©tection: R√©inscription Master - message:', lowerMessage);
                    const result = await updateProfile('inscription_type', 'master');
                    console.log('üìä R√©sultat updateProfile:', result);
                    // Toujours consid√©rer comme mis √† jour si updateProfile a √©t√© appel√©
                    // (m√™me si le r√©sultat n'est pas parfait, on continue le flow)
                    updated = true;
                    console.log('‚úÖ Profil marqu√© comme mis √† jour (inscription_type = master)');
                } else if (lowerMessage.includes('premi√®re') || 
                          lowerMessage.includes('premiere') || 
                          lowerMessage.includes('1√®re') || 
                          lowerMessage === 'premiere' || 
                          lowerMessage === 'premi√®re' || 
                          lowerMessage === 'premi√®re inscription' ||
                          lowerMessage === 'premiere inscription') {
                    console.log('‚úÖ D√©tection: Premi√®re inscription - message:', lowerMessage);
                    await updateProfile('inscription_type', 'premiere_inscription');
                    updated = true;
                    console.log('‚úÖ Profil marqu√© comme mis √† jour (inscription_type = premiere_inscription)');
                } else if (lowerMessage.includes('r√©inscription') || lowerMessage.includes('reinscription') || lowerMessage.includes('r√©insc')) {
                    if (!lowerMessage.includes('lap') && !lowerMessage.includes('master') && !lowerMessage.includes('prep')) {
                        // R√©inscription sans pr√©cision - demander le type
                        addMessage('Quel type de r√©inscription ? (LAP, Master, ou Prep\' Concours)', false, [
                            { text: 'LAP' },
                            { text: 'Master' },
                            { text: 'Prep\' Concours', secondary: true }
                        ]);
                        return false;
                    }
                }
            }
            
            // D√©tection cr√©ation de compte
            if ((lowerMessage.includes('cr√©er un compte') || lowerMessage === 'oui') && lastQuestionAsked === 'create_account') {
                showAccountCreationForm();
                return true;
            }
            
            if ((lowerMessage.includes('sans compte') || lowerMessage === 'non') && lastQuestionAsked === 'create_account') {
                skipAccountCreation();
                return true;
            }
            
            // D√©tection pour passer √† la phase 2
            if (lowerMessage.includes('commencer la phase 2') || 
                lowerMessage.includes('phase 2') || 
                (lowerMessage === 'oui' && lastQuestionAsked === 'phase2_confirm') ||
                lowerMessage.includes('oui commencer')) {
                await startPhase2();
                return true;
            }
            
            // Si on demande confirmation phase 2 et que la r√©ponse est non
            if ((lowerMessage === 'non' || lowerMessage.includes('pas maintenant')) && lastQuestionAsked === 'phase2_confirm') {
                addMessage('D\'accord, vous pourrez commencer la Phase 2 quand vous le souhaitez en cliquant sur "Oui, commencer la Phase 2".', false);
                return true;
            }
            
            // 2. D√©tection boursier (si c'est la question en cours)
            if (profile.is_boursier === null && lastQuestionAsked === 'is_boursier') {
                if (lowerMessage === 'oui' || lowerMessage === 'oui' || lowerMessage.includes('oui') || lowerMessage.includes('boursier')) {
                    await updateProfile('is_boursier', true);
                    updated = true;
                } else if (lowerMessage === 'non' || lowerMessage.includes('non') || lowerMessage.includes('pas boursier')) {
                    await updateProfile('is_boursier', false);
                    updated = true;
                }
            } else if (profile.is_boursier === null) {
                // D√©tection m√™me si ce n'est pas la question en cours (au cas o√π)
                if ((lowerMessage.includes('boursier') && lowerMessage.includes('oui')) || (lowerMessage === 'oui' && lastQuestionAsked === 'is_boursier')) {
                    await updateProfile('is_boursier', true);
                    updated = true;
                } else if ((lowerMessage.includes('boursier') && lowerMessage.includes('non')) || (lowerMessage === 'non' && lastQuestionAsked === 'is_boursier')) {
                    await updateProfile('is_boursier', false);
                    updated = true;
                }
            }
            
            // 3. D√©tection mineur
            if (profile.is_mineur === null && lastQuestionAsked === 'is_mineur') {
                if (lowerMessage === 'oui' || lowerMessage.includes('oui') || lowerMessage.includes('je suis mineur')) {
                    await updateProfile('is_mineur', true);
                    updated = true;
                } else if (lowerMessage === 'non' || lowerMessage.includes('non') || lowerMessage.includes('majeur')) {
                    await updateProfile('is_mineur', false);
                    updated = true;
                }
            } else if (profile.is_mineur === null && lowerMessage.includes('mineur')) {
                if (lowerMessage.includes('oui') || lowerMessage.includes('je suis mineur')) {
                    await updateProfile('is_mineur', true);
                    updated = true;
                } else if (lowerMessage.includes('non') || lowerMessage.includes('majeur')) {
                    await updateProfile('is_mineur', false);
                    updated = true;
                }
            }
            
            // 4. D√©tection autre √©tablissement
            if (profile.inscrit_autre_etablissement === null && lastQuestionAsked === 'inscrit_autre_etablissement') {
                if (lowerMessage === 'oui' || lowerMessage.includes('oui') || lowerMessage.includes('d√©j√†') || lowerMessage.includes('deja')) {
                    await updateProfile('inscrit_autre_etablissement', true);
                    updated = true;
                } else if (lowerMessage === 'non' || lowerMessage.includes('non') || lowerMessage.includes('pas')) {
                    await updateProfile('inscrit_autre_etablissement', false);
                    updated = true;
                }
            } else if (profile.inscrit_autre_etablissement === null && (lowerMessage.includes('autre √©tablissement') || lowerMessage.includes('autre etablissement'))) {
                if (lowerMessage.includes('oui') || lowerMessage.includes('d√©j√†') || lowerMessage.includes('deja')) {
                    await updateProfile('inscrit_autre_etablissement', true);
                    updated = true;
                } else if (lowerMessage.includes('non') || lowerMessage.includes('pas')) {
                    await updateProfile('inscrit_autre_etablissement', false);
                    updated = true;
                }
            }
            
            // 5. D√©tection JDC
            if (profile.has_jdc === null && lastQuestionAsked === 'has_jdc') {
                if (lowerMessage === 'oui' || lowerMessage.includes('oui') || lowerMessage.includes('d√©j√†') || lowerMessage.includes('deja') || lowerMessage.includes('fourni')) {
                    await updateProfile('has_jdc', true);
                    updated = true;
                } else if (lowerMessage === 'non' || lowerMessage.includes('non') || lowerMessage.includes('pas encore') || lowerMessage.includes('pas fourni')) {
                    await updateProfile('has_jdc', false);
                    updated = true;
                }
            } else if (profile.has_jdc === null && (lowerMessage.includes('jdc') || lowerMessage.includes('d√©fense') || lowerMessage.includes('defense'))) {
                if (lowerMessage.includes('oui') || lowerMessage.includes('d√©j√†') || lowerMessage.includes('deja') || lowerMessage.includes('fourni')) {
                    await updateProfile('has_jdc', true);
                    updated = true;
                } else if (lowerMessage.includes('non') || lowerMessage.includes('pas encore') || lowerMessage.includes('pas fourni')) {
                    await updateProfile('has_jdc', false);
                    updated = true;
                }
            }
            
            return updated;
        }

        // Variable pour √©viter de poser la m√™me question plusieurs fois
        let lastQuestionAsked = null;
        let questionInProgress = false;

        // Fonction pour poser la prochaine question selon l'√©tat du profil
        async function askNextQuestion() {
            console.log('üìã askNextQuestion() appel√©e');
            console.log('   - currentSessionId:', currentSessionId);
            console.log('   - currentPhase:', currentPhase);
            console.log('   - questionInProgress:', questionInProgress);
            console.log('   - lastQuestionAsked:', lastQuestionAsked);
            
            // Si la phase est incorrecte, la corriger
            if (currentSessionId && currentPhase !== 'collecte_info') {
                console.log('‚ö†Ô∏è Phase incorrecte dans askNextQuestion:', currentPhase, '- Passage √† collecte_info');
                currentPhase = 'collecte_info';
                updatePhaseIndicator(currentPhase, currentSessionId);
            }
            
            if (!currentSessionId) {
                console.log('‚ùå Pas de sessionId, sortie');
                return;
            }
            
            if (currentPhase !== 'collecte_info') {
                console.log('‚ùå Phase incorrecte apr√®s correction:', currentPhase, '- sortie');
                return;
            }
            if (questionInProgress) {
                console.log('‚è∏Ô∏è Question en cours, sortie');
                return; // √âviter les appels multiples
            }
            
            questionInProgress = true;
            console.log('üîí questionInProgress = true');
            
            try {
                const profile = await checkProfileStatus();
                if (!profile) {
                    console.log('‚ùå Pas de profil trouv√©');
                    questionInProgress = false;
                    return;
                }
                
                console.log('üìä Profil actuel:', {
                    inscription_type: profile.inscription_type,
                    is_boursier: profile.is_boursier,
                    is_mineur: profile.is_mineur,
                    inscrit_autre_etablissement: profile.inscrit_autre_etablissement,
                    has_jdc: profile.has_jdc,
                    phase: profile.phase
                });
                
                // Si la phase 1 est compl√®te, ne rien faire (sera g√©r√© par updateProfile)
                if (profile.phase === 'remplissage_formulaire') {
                    console.log('‚úÖ Phase 1 compl√®te, sortie');
                    questionInProgress = false;
                    return;
                }
                
                // D√©terminer quelle question poser selon ce qui manque
                let questionToAsk = null;
                
                if (!profile.inscription_type) {
                    questionToAsk = 'inscription_type';
                } else if (profile.is_boursier === null) {
                    questionToAsk = 'is_boursier';
                } else if (profile.is_mineur === null) {
                    questionToAsk = 'is_mineur';
                } else if (profile.inscrit_autre_etablissement === null) {
                    questionToAsk = 'inscrit_autre_etablissement';
                } else if (profile.has_jdc === null) {
                    questionToAsk = 'has_jdc';
                }
                
                console.log('‚ùì Question √† poser:', questionToAsk);
                console.log('üìù Derni√®re question pos√©e:', lastQuestionAsked);
                
                // Ne poser la question que si elle est diff√©rente de la derni√®re
                if (questionToAsk && questionToAsk !== lastQuestionAsked) {
                    lastQuestionAsked = questionToAsk;
                    console.log('‚úÖ Nouvelle question d√©tect√©e, affichage...');
                    
                    if (questionToAsk === 'inscription_type') {
                        // Si inscription_type n'est pas d√©fini, poser la question
                        addMessage('Pour commencer, √™tes-vous en <strong>premi√®re inscription</strong> ou en <strong>r√©inscription</strong> ?', false, [
                            { text: 'Premi√®re inscription' },
                            { text: 'R√©inscription LAP', secondary: true },
                            { text: 'R√©inscription Master', secondary: true },
                            { text: 'R√©inscription Prep\' Concours', secondary: true }
                        ]);
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                        setTimeout(() => {
                            questionInProgress = false;
                        }, 100);
                        return;
                    } else if (questionToAsk === 'is_boursier') {
                        console.log('üí¨ Affichage question: boursier');
                        addMessage('√ätes-vous <strong>boursier</strong> pour l\'ann√©e universitaire en cours ?', false, [
                            { text: 'Oui' },
                            { text: 'Non', secondary: true }
                        ]);
                    } else if (questionToAsk === 'is_mineur') {
                        console.log('üí¨ Affichage question: mineur');
                        addMessage('√ätes-vous <strong>mineur</strong> ?', false, [
                            { text: 'Oui' },
                            { text: 'Non', secondary: true }
                        ]);
                    } else if (questionToAsk === 'inscrit_autre_etablissement') {
                        console.log('üí¨ Affichage question: inscrit autre √©tablissement');
                        addMessage('√ätes-vous d√©j√† inscrit dans un <strong>autre √©tablissement</strong> ?', false, [
                            { text: 'Oui' },
                            { text: 'Non', secondary: true }
                        ]);
                    } else if (questionToAsk === 'has_jdc') {
                        console.log('üí¨ Affichage question: JDC');
                        addMessage('Avez-vous d√©j√† fourni votre <strong>attestation JDC</strong> (Journ√©e D√©fense et Citoyennet√©) ou attestation d\'exemption ?', false, [
                            { text: 'Oui' },
                            { text: 'Non', secondary: true }
                        ]);
                    }
                    
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                    questionInProgress = false;
                    console.log('üîì questionInProgress = false (question affich√©e)');
                } else if (!questionToAsk) {
                    // Toutes les questions sont r√©pondues, v√©rifier si on peut passer √† la phase 2
                    if (profile.inscription_type && 
                        profile.is_boursier !== null && 
                        profile.is_mineur !== null && 
                        profile.inscrit_autre_etablissement !== null && 
                        profile.has_jdc !== null) {
                        // Forcer le passage √† la phase 2
                        const updateResponse = await fetch(`/api/profile/${currentSessionId}/update`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({})
                        });
                        const updateData = await updateResponse.json();
                        if (updateData.phase1_complete) {
                    // Ne pas passer automatiquement, afficher le r√©sum√© avec confirmation
                    if (updateData.phase1_complete) {
                        showPhase1Summary(updateData.profile);
                    }
                        }
                    }
                }
            } catch (error) {
                console.error('Erreur lors de la pose de la question suivante:', error);
            } finally {
                questionInProgress = false;
            }
        }
    </script>
</body>
</html>

